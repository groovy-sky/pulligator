name: az-app1
runtime: yaml
description: "Service: az-app1 (creates an empty resource group)"

config:
  az-app1:location:
    type: string
  az-app1:resourceGroupName:
    type: string
  az-app1:tags:
    type: object
  az-app1:bicepTemplatePath:
    type: string

variables:
  bicepTemplatePath: ${az-app1:bicepTemplatePath}
  bicepTemplateHash:
    fn::invoke:
      function: std:filebase64sha256
      arguments:
        input: ${az-app1:bicepTemplatePath}
      return: result
  deploymentLocation: ${az-app1:location}

resources:
  buildBicep:
    type: command:local:Command
    properties:
      create: ../../../../shared/scripts/bicep-build.sh ${bicepTemplatePath} --stdout
      update: ../../../../shared/scripts/bicep-build.sh ${bicepTemplatePath} --stdout
      delete: echo "no-op"
      triggers:
        - ${bicepTemplateHash}
        - ${az-app1:resourceGroupName}

  rgDeployment:
    type: azure-native:resources:DeploymentAtSubscriptionScope
    properties:
      location: ${deploymentLocation}
      properties:
        mode: Incremental
        template:
          fn::invoke:
            function: std:jsondecode
            arguments:
              input: ${buildBicep.stdout}
            return: result
        parameters:
          location:
            value: ${az-app1:location}
          resourceGroupName:
            value: ${az-app1:resourceGroupName}
          tags:
            value: ${az-app1:tags}
    options:
      dependsOn:
        - ${buildBicep}

outputs:
  resourceGroupName: ${az-app1:resourceGroupName}
  resourceGroupId: /subscriptions/${azure-native:subscriptionId}/resourceGroups/${az-app1:resourceGroupName}